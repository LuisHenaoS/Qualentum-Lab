Vagrant.configure("2") do |config|
    config.vm.box = "debian/bullseye64"
    config.vm.hostname = "local.qualentum.org"
    config.vm.provider "virtualbox" do |vb|
        vb.memory = "1024"
        vb.cpus = 2
    end

  # Configuración de la carpeta compartida (opcional)
    config.vm.synced_folder "C:/Users/luiis/Desktop", "/home/vagrant/sync"

  # Script de aprovisionamiento optimizado
    config.vm.provision "shell", inline: <<-SHELL
    # Actualizar repositorio solo si es necesario
    sudo apt update

  # Instalar curl solo si no está ya instalado
  if ! command -v curl > /dev/null; then
    sudo apt install -y curl
  fi

  # Instalar vim solo si no está ya instalado
  if ! command -v vim > /dev/null; then
    sudo apt install -y vim
  fi

  # Instalar Nginx solo si no está ya instalado
  if ! command -v nginx > /dev/null; then
    sudo apt install -y nginx
  fi

  # Instalar pip3 solo si no está ya instalado
  if ! command -v pip3 > /dev/null; then
    sudo apt install -y python3-pip
  fi

  # Instalar Gunicorn y Flask solo si no están ya instalado
  if ! python3 -m pip show flask > /dev/null 2>&1; then
    pip3 install gunicorn flask werkzeug
  fi

  # Generar certificados SSL solo si no existen
  if [ ! -f /home/vagrant/cert.pem ] || [ ! -f /home/vagrant/key.pem ]; then
    openssl req -x509 -newkey rsa:4096 -nodes -out /home/vagrant/cert.pem -keyout /home/vagrant/key.pem -days 365 -subj "/CN=local.qualentum.org"

    sudo chmod 644 /home/vagrant/cert.pem /home/vagrant/key.pem
  fi

  # Configuración de Nginx solo si no existe el archivo de configuración
if [ ! -f /etc/nginx/sites-available/flask_app ]; then
  cat <<'EOF' | sudo tee /etc/nginx/sites-available/flask_app > /dev/null
  server {
      listen 443 ssl;
      server_name local.qualentum.org;

      ssl_certificate     /home/vagrant/cert.pem;
      ssl_certificate_key /home/vagrant/key.pem;

      location / {
          proxy_pass http://localhost:8888;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
      }
  }

  server {
      listen 80;
      server_name local.qualentum.org;

      return 301 https://$host$request_uri;
  }
EOF

      # Activar configuración de Nginx y reiniciar el servicio
      sudo ln -s /etc/nginx/sites-available/flask_app /etc/nginx/sites-enabled/
      sudo rm -f /etc/nginx/sites-enabled/default
      sudo nginx -t && sudo systemctl restart nginx
    fi
  SHELL
end